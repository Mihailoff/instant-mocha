#!/usr/bin/env node
"use strict";var L=Object.defineProperty;var C=(e,t,n)=>t in e?L(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var _=(e,t,n)=>(C(e,typeof t!="symbol"?t+"":t,n),n),E=(e,t,n)=>{if(!t.has(e))throw TypeError("Cannot "+n)};var x=(e,t,n)=>(E(e,t,"read from private field"),n?n.call(e):t.get(e)),R=(e,t,n)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,n)},$=(e,t,n,a)=>(E(e,t,"write to private field"),a?a.call(e,n):t.set(e,n),n);var d,ve=require("module"),O=require("mocha/lib/cli/run.js"),N=require("mocha/lib/cli/options.js"),U=require("yargs/yargs"),V=require("path"),B=require("assert"),Q=require("mocha/lib/cli/collect-files.js"),D=require("os"),H=require("mocha"),J=require("mocha/lib/suite.js"),k=require("memfs"),K=require("fs-require"),z=require("source-map-support"),G=require("webpack"),X=require("fs"),Y=require("url");function s(e){return e&&typeof e=="object"&&"default"in e?e:{default:e}}var S=s(O),Z=s(U),y=s(V),q=s(B),ee=s(Q),j=s(D),te=s(H),b=s(J),re=s(z),F=s(G),ne=s(X),l=require;function ae(e,t=1,n={}){const{indent:a=" ",includeEmptyLines:r=!1}=n;if(typeof e!="string")throw new TypeError(`Expected \`input\` to be a \`string\`, got \`${typeof e}\``);if(typeof t!="number")throw new TypeError(`Expected \`count\` to be a \`number\`, got \`${typeof t}\``);if(t<0)throw new RangeError(`Expected \`count\` to be at least 0, got \`${t}\``);if(typeof a!="string")throw new TypeError(`Expected \`options.indent\` to be a \`string\`, got \`${typeof a}\``);if(t===0)return e;const o=r?/^/gm:/^(?!\s*$)/gm;return e.replace(o,a.repeat(t))}function oe(e){if(typeof e!="string")throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\$&").replace(/-/g,"\\x2d")}const T=/\s+at.*[(\s](.*)\)?/,ie=/^(?:(?:(?:node|node:[\w/]+|(?:(?:node:)?internal\/[\w/]*|.*node_modules\/(?:babel-polyfill|pirates)\/.*)?\w+)(?:\.js)?:\d+:\d+)|native)/,se=typeof j.default.homedir=="undefined"?"":j.default.homedir().replace(/\\/g,"/");function ce(e,{pretty:t=!1,basePath:n}={}){const a=n&&new RegExp(`(at | \\()${oe(n.replace(/\\/g,"/"))}`,"g");if(typeof e=="string")return e.replace(/\\/g,"/").split(`
`).filter(r=>{const o=r.match(T);if(o===null||!o[1])return!0;const i=o[1];return i.includes(".app/Contents/Resources/electron.asar")||i.includes(".app/Contents/Resources/default_app.asar")||i.includes("node_modules/electron/dist/resources/electron.asar")||i.includes("node_modules/electron/dist/resources/default_app.asar")?!1:!ie.test(i)}).filter(r=>r.trim()!=="").map(r=>(a&&(r=r.replace(a,"$1")),t&&(r=r.replace(T,(o,i)=>o.replace(i,i.replace(se,"~")))),r)).join(`
`)}const ue=e=>e.replace(/\s+at .*aggregate-error\/index.js:\d+:\d+\)?/g,"");class I extends Error{constructor(n){if(!Array.isArray(n))throw new TypeError(`Expected input to be an Array, got ${typeof n}`);n=n.map(r=>r instanceof Error?r:r!==null&&typeof r=="object"?Object.assign(new Error(r.message),r):new Error(r));let a=n.map(r=>typeof r.stack=="string"&&r.stack.length>0?ue(ce(r.stack)):String(r)).join(`
`);a=`
`+ae(a,4);super(a);R(this,d,void 0);_(this,"name","AggregateError");$(this,d,n)}get errors(){return x(this,d).slice()}}d=new WeakMap;const f=k.createFsFromVolume(new k.Volume);f.join=y.default.join,re.default.install({environment:"node",retrieveFile(e){if(f.existsSync(e))return f.readFileSync(e).toString()}});const le=e=>K.createFsRequire(f,{fs:!0})(e);function pe(e){const t=new te.default(e);function n(){return new Promise(a=>{this.run.call(this,a)})}return t.$run=n,t.loadFilesAsync=async function(){const{suite:r,files:o}=this;this.lazyLoadFiles(!0);for(let i of o)i=y.default.posix.resolve(i),r.emit(b.default.constants.EVENT_FILE_PRE_REQUIRE,global,i,this),r.emit(b.default.constants.EVENT_FILE_REQUIRE,await le(i),i,this),r.emit(b.default.constants.EVENT_FILE_POST_REQUIRE,global,i,this)},t}async function P(e){const t=pe(e);return t.files=["/main.js"],await t.loadFilesAsync(),await t.$run()}function fe(e,t){var n,a;const r={...e};if(r.entry=t,r.output={...e.output,path:"/",publicPath:"",filename:"main.js",globalObject:"this",libraryTarget:"commonjs2"},!Array.isArray(r.externals)){const{externals:c}=r;r.externals=[],c&&r.externals.push(c)}if(((n=F.default.version)==null?void 0:n.split(".")[0])>"4")r.externalsPresets||(r.externalsPresets={}),r.externalsPresets.node=!0,Object.assign(r.output,{chunkLoading:"require",chunkFormat:"commonjs"});else{const c=l("webpack/lib/LoaderTargetPlugin"),g=l("webpack/lib/FunctionModulePlugin"),m=l("webpack/lib/node/NodeTemplatePlugin"),u=l("webpack/lib/node/ReadFileCompileWasmTemplatePlugin"),w=l("webpack/lib/node/NodeTargetPlugin"),A=(a=r.target)!=null?a:"web";r.target=p=>{new m().apply(p),new u(r.output).apply(p),new g(r.output).apply(p),new w().apply(p),new c(A).apply(p)}}const o=F.default(r);o.outputFileSystem=f;function i(){return new Promise((c,g)=>{this.run((m,u)=>{if(m){g(m);return}if(u.hasErrors()){g(new I(u.compilation.errors));return}if(u.hasWarnings())for(const w of u.compilation.warnings)console.log(w);c(u)})})}return o.$run=i,o}function de(e){return new Function("id","return import(id);")(e)}async function ge(e){try{return l(e)}catch(t){if(t.code==="ERR_REQUIRE_ESM"){process.platform==="win32"&&(e=Y.pathToFileURL(e).href);const{default:n}=await de(e);return n}throw new Error(`Faild to load Webpack configuration: ${e}`)}}async function me(e,t){q.default(ne.default.existsSync(e),`Invalid Webpack configuration path: ${e}`);const n=await ge(e);if(typeof n=="function"){const a={};t.watch?a.WEBPACK_WATCH=!0:a.WEBPACK_BUILD=!0;const r={env:a};return t.mode&&(r.mode=t.mode),t.watch&&(r.watch=t.watch),n(a,r)}return t.mode&&(n.mode=t.mode),n}const h="\x1B[",M=`${h}2J`,he=process.platform==="win32"?`${M}${h}0f`:`${M}${h}3J${h}H`;async function we(e){q.default(e.webpackConfig,"Webpack configuration path must be passed in");const t=y.default.resolve(e.webpackConfig),n=await me(t,e),a=ee.default({ignore:[],file:[],...e});e.watch&&(n.plugins||(n.plugins=[]),n.plugins.unshift({apply(o){o.hooks.watchRun.tap("InstantMocha",()=>{process.stdout.write(he)})}}));const r=fe(n,a);if(e.watch)r.watch({},(o,i)=>{if(o){console.log(o);return}if(i.hasErrors()){console.log(new I(i.compilation.errors));return}if(i.hasWarnings())for(const c of i.compilation.warnings)console.log(c);setImmediate(()=>{P(e)})});else return await r.$run(),await P(e)}const{version:ye}=l("../package.json"),v="instant-mocha options",W=N.loadOptions(process.argv.slice(2));Z.default().scriptName("instant-mocha").command({...S.default,command:["$0 [spec..]"],describe:"Build tests with Webpack and run them with Mocha",builder(e){const t=new Set(["watch","watch-files","watch-ignore"]),n=Object.assign(Object.create(e),{options(a){const r={};for(const o in a)t.has(o)||(r[o]=a[o]);return e.options.call(this,r)}});S.default.builder(n)},async handler(e){try{await we(e)>0&&process.exit(1)}catch(t){console.error(t),process.exit(1)}}}).options({"webpack-config":{description:"Path to Webpack configuration",group:v,type:"string",default:"webpack.config.js"},watch:{description:"Watch mode",group:v},mode:{description:"Mode passed to webpack development|production",group:v,type:"string",alias:"m"}}).help("help","Show usage information & exit").alias("help","h").version("version","Show version number & exit",ye).alias("version","V").wrap(process.stdout.columns?Math.min(process.stdout.columns,80):80).config(W).parse(W._);
